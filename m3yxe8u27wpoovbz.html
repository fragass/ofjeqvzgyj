<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <script>
        if (!sessionStorage.getItem("token") || !sessionStorage.getItem("loggedUser")) {
            window.location.href = "index.html";
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PÃ¡gina inicial - Workday</title>

    <!-- TODO SEU CSS PERMANECE IGUAL -->
    <style>
        /* (CSS exatamente como vocÃª mandou, nÃ£o alterei nada) */
    </style>
</head>
<body>

<!-- TODO SEU HTML PERMANECE IGUAL -->
<div class="side-panel right-panel"></div>

<div id="mini-profile">
    <span id="user-phone"></span>
    <svg id="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
</div>

<div id="dropdown-menu">
    <button id="logout">Sair</button>
</div>

<audio id="messageSound" src="message.mp3" preload="auto"></audio>

<div class="online-box">
    <div class="online-header">
        <div class="online-dot"></div>
        <span id="onlineUsers">0</span>
    </div>
</div>

<div class="container">
    <div class="header">
        <span class="warning-text">As mensagens serÃ£o apagadas todos os dias.</span>
        <a href="https://6bh1xntg0kegg8kp.vercel.app/" class="admin-link">ðŸ”’</a>
    </div>

    <div class="messages" id="messages"></div>

    <div class="form">
        <textarea id="content" placeholder="Escreva uma mensagem..."></textarea>
        <span class="emoji-toggle" onclick="toggleEmojis()">ðŸ™‚</span>
        <button class="send-btn" onclick="sendMessage()">Enviar</button>
        <div class="emoji-panel" id="emojiPanel"></div>
    </div>
</div>

<script>
/* =========================
   VARIÃVEIS GLOBAIS
========================== */
const loggedUser = sessionStorage.getItem("loggedUser");
let isAdmin = false;
let lastMessageId = null;
let pendingImageUrl = null;

const userColors = ["#58a6ff","#2ea043","#f0883e","#a371f7","#ff7b72","#1f6feb","#3fb950","#d29922","#bc8cff","#ffa657"];

/* =========================
   ADMIN CHECK (ÃšNICO)
========================== */
async function checkIfAdmin() {
    try {
        const res = await fetch(`/api/check-admin?user=${encodeURIComponent(loggedUser)}`);
        const data = await res.json();
        isAdmin = !!data.isAdmin;
    } catch (e) {
        console.warn("Falha ao verificar admin");
        isAdmin = false;
    }
}

/* =========================
   MENSAGENS
========================== */
async function loadMessages() {
    const res = await fetch("/api/messages");
    const data = await res.json();

    const box = document.getElementById("messages");
    box.innerHTML = "";

    data.forEach(msg => {
        const div = document.createElement("div");
        div.className = "message";

        const userColor = userColors[Math.abs(msg.name.charCodeAt(0)) % userColors.length];
        const date = new Date(msg.created_at).toLocaleString("pt-BR");

        div.innerHTML = `
            <div class="message-header">
                <span class="username" style="color:${userColor}">
                    ${isAdmin && msg.name === loggedUser ? '<span style="color:#ff4d4f;font-weight:700;">ADMIN</span> ' : ''}
                    ${msg.name}
                </span>
                <span class="timestamp">${date}</span>
            </div>
            <div>${msg.image_url
                ? `<a href="${msg.image_url}" target="_blank">ðŸ–¼ Imagem</a>`
                : msg.content}
            </div>
        `;

        box.appendChild(div);
    });

    box.scrollTop = box.scrollHeight;
}

/* =========================
   ENVIO
========================== */
async function sendMessage() {
    const content = document.getElementById("content").value.trim();
    if (!content && !pendingImageUrl) return;

    await fetch("/api/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: loggedUser,
            content: content || "ðŸ–¼ Imagem",
            image_url: pendingImageUrl
        })
    });

    document.getElementById("content").value = "";
    pendingImageUrl = null;
    loadMessages();
}

/* =========================
   ONLINE
========================== */
async function updateOnlineStatus() {
    await fetch("/api/online", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: loggedUser })
    });
}

async function loadOnlineUsers() {
    const res = await fetch("/api/online");
    const data = await res.json();
    document.getElementById("onlineUsers").textContent = data.length;
}

/* =========================
   INIT SEGURO
========================== */
(async () => {
    await checkIfAdmin();
    loadMessages();
    updateOnlineStatus();
    loadOnlineUsers();

    setInterval(loadMessages, 3000);
    setInterval(updateOnlineStatus, 5000);
    setInterval(loadOnlineUsers, 5000);

    document.getElementById("user-phone").textContent = loggedUser;
})();
</script>

</body>
</html>
